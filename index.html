<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>계약서 작성 및 서명 앱</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .tab.active {
            background: white;
            color: #4facfe;
            border-bottom: 3px solid #4facfe;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            margin-bottom: 40px;
        }

        .form-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4facfe;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
        }

        .contract-preview {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 30px;
            line-height: 1.8;
            font-size: 0.95rem;
            max-height: 600px;
            overflow-y: auto;
        }

        .contract-title {
            font-size: 1.3rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        .contract-article {
            margin-bottom: 20px;
        }

        .article-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .contract-article .article-title {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 40px;
        }

        .upload-box {
            border: 3px dashed #e0e0e0;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .upload-box:hover {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.05);
            transform: translateY(-2px);
        }

        .upload-box.dragover {
            border-color: #00f2fe;
            background: rgba(0, 242, 254, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: #4facfe;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .upload-subtext {
            color: #666;
            font-size: 0.9rem;
        }

        input[type="file"] {
            display: none;
        }

        .workspace {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            min-height: 600px;
            position: relative;
            background: white;
            overflow: hidden;
            margin-top: 20px;
        }

        .document-canvas {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: auto;
            padding: 20px;
        }

        .contract-document {
            background: white;
            padding: 40px;
            line-height: 1.8;
            font-size: 0.9rem;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-radius: 10px;
        }

        .signature-overlay {
            position: absolute;
            cursor: move;
            border: 2px dashed transparent;
            border-radius: 5px;
            transition: border-color 0.3s ease;
        }

        .signature-overlay:hover {
            border-color: #4facfe;
        }

        .signature-overlay.selected {
            border-color: #00f2fe;
        }

        .signature-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .controls {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .slider {
            width: 150px;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4facfe;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-large {
            padding: 16px 32px;
            font-size: 1.1rem;
            margin: 20px 0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .hidden {
            display: none;
        }

        .signature-placeholder {
            background: #e3f2fd;
            border: 2px dashed #2196f3;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin: 10px 0;
            color: #1976d2;
            font-weight: 600;
        }

        .checklist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .status-pending {
            color: #ff9800;
            font-weight: 600;
        }

        .status-complete {
            color: #4caf50;
            font-weight: 600;
        }

        .receipt-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .receipt-table th,
        .receipt-table td {
            border: 1px solid #333;
            padding: 12px;
            text-align: left;
        }

        .receipt-table th {
            background: #f5f5f5;
            font-weight: bold;
            text-align: center;
        }

        .receipt-note {
            margin-top: 30px;
            font-size: 0.9rem;
            color: #666;
        }

        /* 계약서 내용 편집 가능한 텍스트 영역 추가 */
        .contract-editor {
            margin-bottom: 30px;
        }

        .contract-template {
            width: 100%;
            min-height: 400px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            line-height: 1.6;
            resize: vertical;
        }

        .contract-template:focus {
            outline: none;
            border-color: #4facfe;
        }

        /* PDF 인쇄 스타일 - 서명 위치 문제 완전 해결 */
        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            body {
                background: white !important;
                font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif !important;
                color: black !important;
                line-height: 1.6 !important;
                font-size: 11pt !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                background: white !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }
            
            .header, .tabs, .controls, .status, .btn, .signature-section {
                display: none !important;
            }
            
            .workspace {
                border: none !important;
                box-shadow: none !important;
                overflow: visible !important;
                height: auto !important;
                margin: 0 !important;
                position: static !important;
            }
            
            .document-canvas {
                padding: 0 !important;
                overflow: visible !important;
                position: static !important;
                height: auto !important;
                width: 100% !important;
            }
            
            .contract-document {
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
                max-width: none !important;
                margin: 0 !important;
                position: static !important;
                width: 100% !important;
            }
            
            /* 서명 오버레이 완전 고정 */
            .signature-overlay {
                position: static !important;
                display: inline-block !important;
                border: none !important;
                transform: none !important;
                left: auto !important;
                top: auto !important;
                margin: 0 !important;
                padding: 0 !important;
                vertical-align: middle !important;
                page-break-inside: avoid !important;
            }
            
            .signature-overlay img {
                max-width: 80px !important;
                max-height: 40px !important;
                width: auto !important;
                height: auto !important;
                display: inline-block !important;
                vertical-align: middle !important;
            }
            
            .tab-content {
                display: none !important;
                padding: 0 !important;
            }
            
            #signatureTab.active,
            #previewTab.active {
                display: block !important;
                padding: 0 !important;
            }
            
            #signatureTab.active .signature-section,
            #signatureTab.active .controls {
                display: none !important;
            }
            
            /* 테이블 인쇄 최적화 */
            table {
                page-break-inside: avoid !important;
                border-collapse: collapse !important;
                width: 100% !important;
            }
            
            td, th {
                border: 1px solid #000 !important;
                padding: 6px !important;
                font-size: 10pt !important;
                vertical-align: middle !important;
            }
            
            .signature-placeholder {
                min-height: 35px !important;
                border: 1px solid #ccc !important;
                background: white !important;
                padding: 5px !important;
                text-align: center !important;
                vertical-align: middle !important;
            }
            
            .contract-title {
                font-size: 14pt !important;
                font-weight: bold !important;
                text-align: center !important;
                margin-bottom: 20px !important;
            }
            
            .contract-article {
                font-size: 10pt !important;
                line-height: 1.5 !important;
                margin-bottom: 15px !important;
            }
        }

        @media (max-width: 768px) {
            .signature-section {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .control-group {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📝 계약서 작성 및 서명</h1>
            <p>계약 정보를 입력하고 서명을 완료하세요</p>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="info">📋 계약 정보 입력</button>
            <button class="tab" data-tab="template">📝 계약서 템플릿 편집</button>
            <button class="tab" data-tab="signature">✍️ 서명 진행</button>
            <button class="tab" data-tab="preview">📄 완성된 계약서</button>
            <button class="tab" data-tab="receipt">🧾 영수증 생성</button>
            <button class="tab" data-tab="export">📤 전송용 파일 생성</button>
        </div>

        <!-- 계약 정보 입력 탭 -->
        <div id="infoTab" class="tab-content active">
            <div class="form-section">
                <div class="form-title">기본 정보</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>행사명</label>
                        <input type="text" id="eventName" value="2025년에 임철민 보기: 골_든_라_이_트">
                    </div>
                    <div class="form-group">
                        <label>행사 장소</label>
                        <input type="text" id="venue" value="키니마(서울시 마포구 대흥로2길 5, 202호">
                    </div>
                    <div class="form-group">
                        <label>행사 시작일</label>
                        <input type="date" id="startDate" value="2025-06-12">
                    </div>
                    <div class="form-group">
                        <label>행사 종료일</label>
                        <input type="date" id="endDate" value="2025-06-29">
                    </div>
                    <div class="form-group">
                        <label>역할</label>
                        <input type="text" id="role" value="특별전 감독">
                    </div>
                    <div class="form-group">
                        <label>내용</label>
                        <input type="text" id="content" value="작품 상영 및 대담 참석">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-title">계약 대금</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>총 사례금 (원)</label>
                        <input type="text" id="totalAmount" value="500,000">
                    </div>
                    <div class="form-group">
                        <label>세금률 (%)</label>
                        <input type="number" id="taxRate" value="3.3" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>세금 (원)</label>
                        <input type="text" id="taxAmount" value="16,500" readonly>
                    </div>
                    <div class="form-group">
                        <label>실수령액 (원)</label>
                        <input type="text" id="netAmount" value="483,500" readonly>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-title">당사자 정보</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>갑 (단체명)</label>
                        <input type="text" id="partyA" value="키니마">
                    </div>
                    <div class="form-group">
                        <label>갑 대표자</label>
                        <input type="text" id="representativeA" value="김나영">
                    </div>
                    <div class="form-group">
                        <label>갑 사업자등록번호</label>
                        <input type="text" id="businessNumber" value="407-17-02376">
                    </div>
                    <div class="form-group">
                        <label>갑 연락처</label>
                        <input type="text" id="contactA" value="010-2710-3297">
                    </div>
                    <div class="form-group">
                        <label>갑 소재지</label>
                        <input type="text" id="addressA" value="서울시 마포구 대흥로2길 5, 202호">
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>을 (개인명)</label>
                        <input type="text" id="partyB" placeholder="이름을 입력하세요">
                    </div>
                    <div class="form-group">
                        <label>을 주민등록번호</label>
                        <input type="text" id="idNumber" placeholder="주민등록번호를 입력하세요">
                    </div>
                    <div class="form-group">
                        <label>을 연락처</label>
                        <input type="text" id="contactB" placeholder="연락처를 입력하세요">
                    </div>
                    <div class="form-group">
                        <label>을 주소</label>
                        <input type="text" id="addressB" placeholder="주소를 입력하세요">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-title">분쟁 해결 방식</div>
                <div class="form-group">
                    <label>분쟁 해결 방식을 선택하세요:</label>
                    <div style="margin-top: 15px;">
                        <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 15px;">
                            <input type="radio" id="arbitration" name="dispute" value="arbitration" style="width: auto; margin-top: 2px; flex-shrink: 0;">
                            <label for="arbitration" style="font-weight: normal; margin-bottom: 0; cursor: pointer;">중재법에 따라 설치된 대한상사중재원의 중재</label>
                        </div>
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <input type="radio" id="court" name="dispute" value="court" style="width: auto; margin-top: 2px; flex-shrink: 0;">
                            <label for="court" style="font-weight: normal; margin-bottom: 0; cursor: pointer;">민사소송법에 따른 법원에서의 소송. 이 경우 제1심 관할법원은 갑이 소재한 지역의 지방법원으로 한다.</label>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary btn-large" onclick="showTab('signature')">✍️ 서명 진행하기</button>
        </div>

        <!-- 계약서 템플릿 편집 탭 -->
        <div id="templateTab" class="tab-content">
            <div class="form-section">
                <div class="form-title">계약서 템플릿 편집</div>
                <p style="margin-bottom: 20px; color: #666;">
                    아래 텍스트를 직접 편집하여 계약서 내용을 수정할 수 있습니다. 
                    {{변수명}} 형태로 된 부분은 자동으로 입력된 정보로 치환됩니다.
                </p>
                
                <div class="contract-editor">
                    <textarea id="contractTemplate" class="contract-template" placeholder="계약서 템플릿을 입력하세요...">
&lt;{{eventName}}&gt; {{role}} 계약서

상영자 {{partyA}} (이하 갑이라 함)와 {{role}} {{partyB}}(이하 을이라 함)은 다음과 같이 &lt;{{eventName}}&gt;(이하 "행사"라 함)와 관련한 계약을 체결한다.

제1조 계약목적
본 계약은 &lt;{{eventName}}&gt; {{content}}에 있어 갑과 을 사이의 권리와 의무를 명확히 하는 것을 목적으로 한다.

제2조 계약개요
① 본 계약의 대상이 되는 행사의 개요는 다음과 같다.

1. 명칭: &lt;{{eventName}}&gt;
2. 일정: {{startDate}} - {{endDate}}
3. 장소: {{venue}}
4. 주최: {{partyA}}
5. 내용: {{content}}

② 을은 상기한 행사의 일정 내 {{role}}으로 참여하며 세부사항은 갑과 을의 합의에 따라 결정한다.

제3조 계약기간
본 계약의 기간은 {{startDate}} - {{endDate}}으로 한다.

제4조 상영의 허락
갑은 을에게 계약에 따라 지정된 작품(이하 '계약 작품'이라 한다)를 지정된 장소에서 지정된 일수만큼 공개 상영할 권리를 부여하며, 갑은 계약 작품을 계약에서 정한 조건 외에 다른 시간이나 장소, 다른 형태의 사용 또는 다른 목적으로 이용할 수 없다.

제5조 계약대금
① 갑은 을에게 상영료 및 대담 참석에 대한 총 사례로 금 {{totalAmountKorean}}원 ({{totalAmountFormatted}})을 법령상의 세금(3.3%) 금 {{taxAmountKorean}}원 ({{taxAmountFormatted}})을 공제한 후 다음의 기준에 따라 지급한다.
                    </textarea>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="color: #1976d2; margin-bottom: 10px;">📝 사용 가능한 변수들:</h4>
                    <div style="font-size: 0.9rem; color: #333; line-height: 1.6;">
                        {{eventName}}, {{venue}}, {{startDate}}, {{endDate}}, {{role}}, {{content}}, 
                        {{totalAmount}}, {{totalAmountKorean}}, {{totalAmountFormatted}}, 
                        {{taxAmount}}, {{taxAmountKorean}}, {{taxAmountFormatted}},
                        {{partyA}}, {{representativeA}}, {{businessNumber}}, {{partyB}}, {{idNumber}}
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="saveTemplate()">💾 템플릿 저장</button>
                <button class="btn btn-secondary" onclick="resetTemplate()">🔄 기본 템플릿으로 복원</button>
            </div>
        </div>

        <!-- 완성된 계약서 탭 -->
        <div id="previewTab" class="tab-content">
            <div id="contractPreview" class="contract-preview">
                <!-- 계약서 내용이 여기에 생성됩니다 -->
            </div>
            <button class="btn btn-primary btn-large" onclick="downloadPDF()">📄 계약서 PDF 다운로드</button>
        </div>

        <!-- 서명 및 완료 탭 -->
        <div id="signatureTab" class="tab-content">
            <div id="statusMessage" class="status hidden"></div>
            
            <div class="signature-section">
                <div class="upload-box" id="signatureUploadA">
                    <div class="upload-icon">✍️</div>
                    <div class="upload-text">갑 서명 업로드</div>
                    <div class="upload-subtext">JPG, PNG 파일을 드래그하거나 클릭하세요</div>
                    <input type="file" id="signatureFileA" accept=".jpg,.jpeg,.png">
                </div>

                <div class="upload-box" id="signatureUploadB">
                    <div class="upload-icon">✍️</div>
                    <div class="upload-text">을 서명 업로드</div>
                    <div class="upload-subtext">JPG, PNG 파일을 드래그하거나 클릭하세요</div>
                    <input type="file" id="signatureFileB" accept=".jpg,.jpeg,.png">
                </div>
            </div>

            <div class="workspace" id="workspace">
                <div class="document-canvas" id="documentCanvas">
                    <div id="finalContract" class="contract-document">
                        <!-- 최종 계약서가 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label>서명 크기:</label>
                    <input type="range" id="sizeSlider" class="slider" min="50" max="200" value="120">
                    <span id="sizeValue">120px</span>
                </div>
                
                <div class="control-group">
                    <label>투명도:</label>
                    <input type="range" id="opacitySlider" class="slider" min="10" max="100" value="100">
                    <span id="opacityValue">100%</span>
                </div>

                <button class="btn btn-secondary" id="removeBackground">배경 제거</button>
                <button class="btn btn-primary" id="downloadPdfBtn">📄 완성된 계약서 보기</button>
            </div>
        </div>

        <!-- 영수증 생성 탭 -->
        <div id="receiptTab" class="tab-content">
            <div class="form-section">
                <div class="form-title">영수증 정보</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>입금은행</label>
                        <input type="text" id="bankName" placeholder="은행명을 입력하세요">
                    </div>
                    <div class="form-group">
                        <label>계좌번호</label>
                        <input type="text" id="accountNumber" placeholder="계좌번호를 입력하세요">
                    </div>
                    <div class="form-group">
                        <label>예금주 성명</label>
                        <input type="text" id="accountHolder" placeholder="예금주명을 입력하세요">
                    </div>
                    <div class="form-group">
                        <label>주민등록번호</label>
                        <input type="text" id="accountHolderID" placeholder="주민등록번호를 입력하세요">
                    </div>
                    <div class="form-group">
                        <label>주소</label>
                        <input type="text" id="accountHolderAddress" placeholder="주소를 입력하세요">
                    </div>
                    <div class="form-group">
                        <label>전화번호</label>
                        <input type="text" id="accountHolderPhone" placeholder="전화번호를 입력하세요">
                    </div>
                </div>
            </div>

            <div id="receiptPreview" class="contract-preview">
                <!-- 영수증 내용이 여기에 생성됩니다 -->
            </div>

            <button class="btn btn-primary btn-large" onclick="generateReceipt()">🧾 영수증 생성</button>
            <button class="btn btn-primary" onclick="downloadReceiptPDF()">📄 영수증 PDF 다운로드</button>
        </div>

        <!-- 전송용 파일 생성 탭 -->
        <div id="exportTab" class="tab-content">
            <div class="form-section">
                <div class="form-title">전송용 파일 생성</div>
                <p style="margin-bottom: 30px; color: #666; line-height: 1.6;">
                    본인(갑)의 서명이 포함된 HTML 파일을 생성하여 상대방(을)에게 전송하세요.<br>
                    상대방은 본인의 정보와 서명만 추가하면 계약이 완료됩니다.
                </p>
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">✅ 확인사항</h3>
                    <div id="exportChecklist">
                        <div class="checklist-item" id="checkContract">📋 계약 정보 입력: <span class="status-pending">대기중</span></div>
                        <div class="checklist-item" id="checkSignatureA">✍️ 갑(본인) 서명: <span class="status-pending">대기중</span></div>
                    </div>
                </div>

                <button class="btn btn-primary btn-large" id="generateExportFile" onclick="generateExportFile()" disabled>
                    📤 상대방 전송용 HTML 파일 생성
                </button>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let signatureDataA = null;
        let signatureDataB = null;
        let currentSignatureA = null;
        let currentSignatureB = null;
        let selectedSignature = null;
        let customTemplate = null;

        // 기본 템플릿 (분쟁해결 변수 추가)
        const defaultTemplate = `&lt;{{eventName}}&gt; {{role}} 계약서

상영자 {{partyA}} (이하 갑이라 함)와 {{role}} {{partyB}}(이하 을이라 함)은 다음과 같이 &lt;{{eventName}}&gt;(이하 "행사"라 함)와 관련한 계약을 체결한다.

제1조 계약목적
본 계약은 &lt;{{eventName}}&gt; {{content}}에 있어 갑과 을 사이의 권리와 의무를 명확히 하는 것을 목적으로 한다.

제2조 계약개요
① 본 계약의 대상이 되는 행사의 개요는 다음과 같다.

1. 명칭: &lt;{{eventName}}&gt;
2. 일정: {{startDate}} - {{endDate}}
3. 장소: {{venue}}
4. 주최: {{partyA}}
5. 내용: {{content}}

② 을은 상기한 행사의 일정 내 {{role}}으로 참여하며 세부사항은 갑과 을의 합의에 따라 결정한다.

제3조 계약기간
본 계약의 기간은 {{startDate}} - {{endDate}}으로 한다.

제4조 상영의 허락
갑은 을에게 계약에 따라 지정된 작품(이하 '계약 작품'이라 한다)를 지정된 장소에서 지정된 일수만큼 공개 상영할 권리를 부여하며, 갑은 계약 작품을 계약에서 정한 조건 외에 다른 시간이나 장소, 다른 형태의 사용 또는 다른 목적으로 이용할 수 없다.

제5조 계약대금
① 갑은 을에게 상영료 및 대담 참석에 대한 총 사례로 금 {{totalAmountKorean}}원 ({{totalAmountFormatted}})을 법령상의 세금(3.3%) 금 {{taxAmountKorean}}원 ({{taxAmountFormatted}})을 공제한 후 다음의 기준에 따라 지급한다.`;

        // 탭 전환 함수
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(function(content) {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            document.querySelector('[data-tab="' + tabName + '"]').classList.add('active');
            
            if (tabName === 'signature') {
                generateFinalContract();
                // 서명 배치 기능을 다시 활성화
                setTimeout(() => {
                    if (signatureDataA) enableSignaturePlacement('A');
                    if (signatureDataB) enableSignaturePlacement('B');
                }, 100);
            } else if (tabName === 'export') {
                updateChecklist();
            } else if (tabName === 'receipt') {
                // 영수증 탭으로 이동할 때 자동으로 계약 정보 반영
                updateReceiptFields();
            } else if (tabName === 'preview') {
                // 완성된 계약서 탭으로 이동할 때 계약서 생성
                updatePreview();
            }
        }

        // 템플릿 저장
        function saveTemplate() {
            customTemplate = document.getElementById('contractTemplate').value;
            showStatus('템플릿이 저장되었습니다!', 'success');
        }

        // 템플릿 초기화
        function resetTemplate() {
            document.getElementById('contractTemplate').value = defaultTemplate;
            customTemplate = null;
            showStatus('기본 템플릿으로 복원되었습니다!', 'success');
        }

        // 숫자 포맷팅 함수
        function formatNumber(num) {
            return parseInt(num).toLocaleString();
        }

        function unformatNumber(str) {
            return str.replace(/,/g, '');
        }

        // 금액 계산
        function calculateAmounts() {
            const totalAmountInput = document.getElementById('totalAmount');
            const taxRateInput = document.getElementById('taxRate');
            const taxAmountInput = document.getElementById('taxAmount');
            const netAmountInput = document.getElementById('netAmount');
            
            const totalAmount = parseFloat(unformatNumber(totalAmountInput.value)) || 0;
            const taxRate = parseFloat(taxRateInput.value) || 0;
            const taxAmount = Math.round(totalAmount * taxRate / 100);
            const netAmount = totalAmount - taxAmount;
            
            taxAmountInput.value = formatNumber(taxAmount);
            netAmountInput.value = formatNumber(netAmount);
        }

        // 계약서 미리보기 업데이트
        function updatePreview() {
            const contractHtml = generateContractHtml();
            document.getElementById('contractPreview').innerHTML = contractHtml;
            showTab('preview');
        }

        // 변수 치환 함수
        function replaceVariables(template) {
            const eventName = document.getElementById('eventName').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const venue = document.getElementById('venue').value;
            const role = document.getElementById('role').value;
            const content = document.getElementById('content').value;
            const totalAmount = document.getElementById('totalAmount').value;
            const taxAmount = document.getElementById('taxAmount').value;
            const partyA = document.getElementById('partyA').value;
            const representativeA = document.getElementById('representativeA').value;
            const businessNumber = document.getElementById('businessNumber').value;
            const contactA = document.getElementById('contactA').value;
            const addressA = document.getElementById('addressA').value;
            const partyB = document.getElementById('partyB').value;
            const idNumber = document.getElementById('idNumber').value;
            const contactB = document.getElementById('contactB').value;
            const addressB = document.getElementById('addressB').value;
            
            const totalAmountKorean = numberToKorean(unformatNumber(totalAmount));
            const taxAmountKorean = numberToKorean(unformatNumber(taxAmount));
            const totalAmountFormatted = parseInt(unformatNumber(totalAmount)).toLocaleString();
            const taxAmountFormatted = parseInt(unformatNumber(taxAmount)).toLocaleString();

            // 분쟁 해결 방식 추가
            const disputeMethod = document.querySelector('input[name="dispute"]:checked');
            let disputeClause = '';
            if (disputeMethod) {
                if (disputeMethod.value === 'arbitration') {
                    disputeClause = '본 계약과 관련하여 분쟁이 발생한 경우에는 중재법에 따라 설치된 대한상사중재원의 중재에 의하여 해결한다.';
                } else if (disputeMethod.value === 'court') {
                    disputeClause = '본 계약과 관련하여 분쟁이 발생한 경우에는 민사소송법에 따른 법원에서의 소송에 의하여 해결하며, 제1심 관할법원은 갑이 소재한 지역의 지방법원으로 한다.';
                }
            }

            return template
                .replace(/\{\{eventName\}\}/g, eventName)
                .replace(/\{\{startDate\}\}/g, startDate)
                .replace(/\{\{endDate\}\}/g, endDate)
                .replace(/\{\{venue\}\}/g, venue)
                .replace(/\{\{role\}\}/g, role)
                .replace(/\{\{content\}\}/g, content)
                .replace(/\{\{totalAmount\}\}/g, totalAmount)
                .replace(/\{\{totalAmountKorean\}\}/g, totalAmountKorean)
                .replace(/\{\{totalAmountFormatted\}\}/g, totalAmountFormatted)
                .replace(/\{\{taxAmount\}\}/g, taxAmount)
                .replace(/\{\{taxAmountKorean\}\}/g, taxAmountKorean)
                .replace(/\{\{taxAmountFormatted\}\}/g, taxAmountFormatted)
                .replace(/\{\{partyA\}\}/g, partyA)
                .replace(/\{\{representativeA\}\}/g, representativeA)
                .replace(/\{\{businessNumber\}\}/g, businessNumber)
                .replace(/\{\{contactA\}\}/g, contactA)
                .replace(/\{\{addressA\}\}/g, addressA)
                .replace(/\{\{partyB\}\}/g, partyB)
                .replace(/\{\{idNumber\}\}/g, idNumber)
                .replace(/\{\{contactB\}\}/g, contactB)
                .replace(/\{\{addressB\}\}/g, addressB)
                .replace(/\{\{disputeClause\}\}/g, disputeClause);
        }

        // 계약서 HTML 생성 (수정된 버전)
        function generateContractHtml() {
            const template = customTemplate || defaultTemplate;
            let processedContent = replaceVariables(template);
            
            // 분쟁 해결 조항 자동 추가
            const disputeMethod = document.querySelector('input[name="dispute"]:checked');
            if (disputeMethod) {
                let disputeClause = '';
                if (disputeMethod.value === 'arbitration') {
                    disputeClause = '\n\n제6조 분쟁해결\n본 계약과 관련하여 분쟁이 발생한 경우에는 중재법에 따라 설치된 대한상사중재원의 중재에 의하여 해결한다.';
                } else if (disputeMethod.value === 'court') {
                    disputeClause = '\n\n제6조 분쟁해결\n본 계약과 관련하여 분쟁이 발생한 경우에는 민사소송법에 따른 법원에서의 소송에 의하여 해결하며, 제1심 관할법원은 갑이 소재한 지역의 지방법원으로 한다.';
                }
                processedContent += disputeClause;
            }
            
            // 오늘 날짜 추가
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const dateString = `${year}년 ${month}월 ${day}일`;
            
            processedContent += '\n\n' + dateString;
            
            // 줄바꿈을 HTML 줄바꿈으로 변환
            let htmlContent = processedContent.replace(/\n/g, '<br>');
            
            // 제목 볼드 처리 (제1조, 제2조 등)
            htmlContent = htmlContent.replace(/제(\d+)조\s+([^<]+)/g, '<strong>제$1조 $2</strong>');
            
            // 서명 테이블 추가
            const signatureTable = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 40px;">' +
                '<div><table style="width: 100%; border-collapse: collapse;"><tr><td style="border: 1px solid #333; padding: 8px; font-weight: bold;">갑</td><td style="border: 1px solid #333; padding: 8px;">단체</td><td style="border: 1px solid #333; padding: 8px;">' + document.getElementById('partyA').value + '(대표 ' + document.getElementById('representativeA').value + ')</td><td style="border: 1px solid #333; padding: 8px;"><div class="signature-placeholder" id="signaturePlaceA">(갑 서명)</div></td></tr><tr><td style="border: 1px solid #333; padding: 8px;">사업자등록번호</td><td style="border: 1px solid #333; padding: 8px;" colspan="3">' + document.getElementById('businessNumber').value + '</td></tr></table></div>' +
                '<div><table style="width: 100%; border-collapse: collapse;"><tr><td style="border: 1px solid #333; padding: 8px; font-weight: bold;">을</td><td style="border: 1px solid #333; padding: 8px;">개인</td><td style="border: 1px solid #333; padding: 8px;">' + document.getElementById('partyB').value + '</td><td style="border: 1px solid #333; padding: 8px;"><div class="signature-placeholder" id="signaturePlaceB">(을 서명)</div></td></tr><tr><td style="border: 1px solid #333; padding: 8px;">주민등록번호</td><td style="border: 1px solid #333; padding: 8px;" colspan="3">' + document.getElementById('idNumber').value + '</td></tr></table></div></div>';

            return '<div class="contract-title">' + htmlContent.split('<br>')[0] + '</div>' +
                   '<div class="contract-article">' + htmlContent.substring(htmlContent.indexOf('<br>') + 4) + '</div>' +
                   signatureTable;
        }

        // 최종 계약서 생성
        function generateFinalContract() {
            const contractHtml = generateContractHtml();
            document.getElementById('finalContract').innerHTML = contractHtml;
        }

        // 숫자를 한글로 변환하는 함수
        function numberToKorean(num) {
            const units = ['', '일', '이', '삼', '사', '오', '육', '칠', '팔', '구'];
            const tens = ['', '십', '백', '천'];
            const tenThousands = ['', '만', '억', '조'];
            
            if (num === 0) return '영';
            
            let result = '';
            let unitIndex = 0;
            
            while (num > 0) {
                let part = num % 10000;
                if (part > 0) {
                    let partStr = '';
                    let digitIndex = 0;
                    
                    while (part > 0) {
                        let digit = part % 10;
                        if (digit > 0) {
                            if (digit === 1 && digitIndex > 0) {
                                partStr = tens[digitIndex] + partStr;
                            } else {
                                partStr = units[digit] + tens[digitIndex] + partStr;
                            }
                        }
                        part = Math.floor(part / 10);
                        digitIndex++;
                    }
                    
                    result = partStr + tenThousands[unitIndex] + result;
                }
                num = Math.floor(num / 10000);
                unitIndex++;
            }
            
            return result;
        }

        // 파일 업로드 처리
        function setupFileUpload(uploadBox, fileInput, callback) {
            uploadBox.addEventListener('click', function() {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    if (!file.type.match(/image\/(jpeg|jpg|png)/i)) {
                        showStatus('JPG, JPEG, PNG 파일만 업로드 가능합니다.', 'processing');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        callback(e.target.result, file);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // 갑 서명 업로드 처리
        function handleSignatureUploadA(dataUrl, file) {
            console.log('갑 서명 업로드 완료');
            signatureDataA = dataUrl;
            const uploadBox = document.getElementById('signatureUploadA');
            uploadBox.style.borderColor = '#4caf50';
            uploadBox.style.background = '#e8f5e8';
            uploadBox.querySelector('.upload-text').textContent = '갑 서명 업로드 완료 ✓';
            uploadBox.querySelector('.upload-subtext').textContent = file.name;
            
            showStatus('갑의 서명이 업로드되었습니다! 서명 탭에서 배치하세요.', 'success');
            
            // 현재 서명 탭에 있다면 즉시 배치 기능 활성화
            if (document.getElementById('signatureTab').classList.contains('active')) {
                enableSignaturePlacement('A');
            }
            updateChecklist();
        }

        // 을 서명 업로드 처리
        function handleSignatureUploadB(dataUrl, file) {
            console.log('을 서명 업로드 완료');
            signatureDataB = dataUrl;
            const uploadBox = document.getElementById('signatureUploadB');
            uploadBox.style.borderColor = '#4caf50';
            uploadBox.style.background = '#e8f5e8';
            uploadBox.querySelector('.upload-text').textContent = '을 서명 업로드 완료 ✓';
            uploadBox.querySelector('.upload-subtext').textContent = file.name;
            
            showStatus('을의 서명이 업로드되었습니다! 서명 탭에서 배치하세요.', 'success');
            
            // 현재 서명 탭에 있다면 즉시 배치 기능 활성화
            if (document.getElementById('signatureTab').classList.contains('active')) {
                enableSignaturePlacement('B');
            }
        }

        // 서명 배치 활성화 (완전히 새로 작성)
        function enableSignaturePlacement(party) {
            console.log('서명 배치 활성화:', party);
            
            // 서명 탭으로 이동했을 때 placeholder를 찾기 위해 지연 실행
            const findAndEnablePlaceholder = () => {
                const placeholder = document.getElementById('signaturePlace' + party);
                console.log('Placeholder 찾기:', placeholder);
                
                if (placeholder) {
                    placeholder.style.cursor = 'pointer';
                    placeholder.style.backgroundColor = '#fff3cd';
                    placeholder.style.border = '2px dashed #ffc107';
                    placeholder.innerHTML = (party === 'A' ? '갑' : '을') + ' 서명 배치 (여기를 클릭하세요)';
                    
                    // 이벤트 리스너 제거 후 새로 추가
                    const newPlaceholder = placeholder.cloneNode(true);
                    placeholder.parentNode.replaceChild(newPlaceholder, placeholder);
                    
                    newPlaceholder.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('서명 배치 클릭:', party);
                        placeSignature(party, newPlaceholder);
                    });
                    
                    console.log('서명 배치 준비 완료:', party);
                } else {
                    console.log('Placeholder를 찾을 수 없음, 재시도...');
                    // placeholder가 없으면 잠시 후 재시도
                    setTimeout(findAndEnablePlaceholder, 200);
                }
            };
            
            findAndEnablePlaceholder();
        }

        // 서명 배치
        function placeSignature(party, placeholder) {
            console.log('서명 배치 실행:', party);
            const signatureData = party === 'A' ? signatureDataA : signatureDataB;
            if (!signatureData) {
                console.log('서명 데이터 없음:', party);
                return;
            }
            
            const existingSignature = party === 'A' ? currentSignatureA : currentSignatureB;
            if (existingSignature) {
                existingSignature.remove();
            }
            
            const signatureOverlay = document.createElement('div');
            signatureOverlay.className = 'signature-overlay';
            signatureOverlay.style.position = 'absolute';
            signatureOverlay.style.width = '120px';
            signatureOverlay.style.height = '60px';
            signatureOverlay.setAttribute('data-party', party);
            
            const signatureImg = document.createElement('img');
            signatureImg.src = signatureData;
            signatureImg.className = 'signature-image';
            
            signatureOverlay.appendChild(signatureImg);
            
            const documentCanvas = document.getElementById('documentCanvas');
            const placeholderRect = placeholder.getBoundingClientRect();
            const canvasRect = documentCanvas.getBoundingClientRect();
            
            signatureOverlay.style.left = (placeholderRect.left - canvasRect.left + documentCanvas.scrollLeft + 10) + 'px';
            signatureOverlay.style.top = (placeholderRect.top - canvasRect.top + documentCanvas.scrollTop + 10) + 'px';
            
            documentCanvas.appendChild(signatureOverlay);
            
            if (party === 'A') {
                currentSignatureA = signatureOverlay;
            } else {
                currentSignatureB = signatureOverlay;
            }
            
            makeDraggable(signatureOverlay);
            
            placeholder.innerHTML = (party === 'A' ? '갑' : '을') + ' 서명 완료 ✓';
            placeholder.style.background = '#d4edda';
            placeholder.style.color = '#155724';
            placeholder.style.border = '2px solid #28a745';
            
            showStatus((party === 'A' ? '갑' : '을') + '의 서명이 배치되었습니다!', 'success');
            
            if (party === 'A') {
                updateChecklist();
            }
            
            console.log('서명 배치 완료:', party);
        }

        // 드래그 기능
        function makeDraggable(element) {
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            element.addEventListener('mousedown', function(e) {
                isDragging = true;
                selectedSignature = element;
                element.classList.add('selected');
                
                startX = e.clientX;
                startY = e.clientY;
                initialX = parseInt(element.style.left);
                initialY = parseInt(element.style.top);
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                element.style.left = (initialX + deltaX) + 'px';
                element.style.top = (initialY + deltaY) + 'px';
            });
            
            document.addEventListener('mouseup', function() {
                isDragging = false;
                if (selectedSignature) {
                    selectedSignature.classList.remove('selected');
                }
            });
        }

        // 영수증 필드 자동 업데이트 함수 추가
        function updateReceiptFields() {
            // 을(상대방) 정보를 영수증 필드에 자동 반영
            const partyB = document.getElementById('partyB').value;
            const idNumber = document.getElementById('idNumber').value;
            const addressB = document.getElementById('addressB').value;
            const contactB = document.getElementById('contactB').value;
            
            if (partyB) document.getElementById('accountHolder').value = partyB;
            if (idNumber) document.getElementById('accountHolderID').value = idNumber;
            if (addressB) document.getElementById('accountHolderAddress').value = addressB;
            if (contactB) document.getElementById('accountHolderPhone').value = contactB;
        }
        function generateReceipt() {
            const eventName = document.getElementById('eventName').value;
            const totalAmount = document.getElementById('totalAmount').value;
            const netAmount = document.getElementById('netAmount').value;
            const bankName = document.getElementById('bankName').value;
            const accountNumber = document.getElementById('accountNumber').value;
            const accountHolder = document.getElementById('accountHolder').value;
            const accountHolderID = document.getElementById('accountHolderID').value;
            const accountHolderAddress = document.getElementById('accountHolderAddress').value;
            const accountHolderPhone = document.getElementById('accountHolderPhone').value;

            const receiptHtml = '<div class="receipt-title">' + eventName + ' 사례비 청구 영수증</div>' +
                '<div style="margin-bottom: 30px;"><strong>1. 사례비 지급 개요</strong></div>' +
                '<table class="receipt-table">' +
                '<tr><th style="width: 50px;">1.</th><th style="width: 100px;">내용</th><td>' + eventName + '</td></tr>' +
                '<tr><th>2.</th><th>일정</th><td>' + document.getElementById('startDate').value + ' - ' + document.getElementById('endDate').value + '</td></tr>' +
                '<tr><th>3.</th><th>장소</th><td>' + document.getElementById('venue').value + '</td></tr>' +
                '<tr><th>4.</th><th>주최</th><td>' + document.getElementById('partyA').value + '</td></tr>' +
                '<tr><th>7.</th><th>사례비</th><td>금 ' + numberToKorean(unformatNumber(totalAmount)) + '원 (' + totalAmount + ')</td></tr>' +
                '</table>' +
                '<div style="margin: 30px 0;"><strong>2. 사례비 지급처</strong></div>' +
                '<table class="receipt-table">' +
                '<tr><th style="width: 50px;">1.</th><th style="width: 100px;">입금은행</th><td>' + bankName + '</td></tr>' +
                '<tr><th>2.</th><th>계좌번호</th><td>' + accountNumber + '</td></tr>' +
                '<tr><th>3.</th><th>예금주 성명</th><td>' + accountHolder + '</td></tr>' +
                '<tr><th>4.</th><th>주민등록번호</th><td>' + accountHolderID + '</td></tr>' +
                '<tr><th>5.</th><th>주소</th><td>' + accountHolderAddress + '</td></tr>' +
                '<tr><th>6.</th><th>전화번호</th><td>' + accountHolderPhone + '</td></tr>' +
                '<tr><th>7.</th><th>실 지급액</th><td>금 ' + numberToKorean(unformatNumber(netAmount)) + '원 (' + netAmount + ')</td></tr>' +
                '</table>' +
                '<div class="receipt-note">• 개인정보 입력 시 세무/회계등으로만 이용하며 용도를 다한 정보는 모두 파기합니다.</div>';

            document.getElementById('receiptPreview').innerHTML = receiptHtml;
            showStatus('영수증이 생성되었습니다!', 'success');
        }

        // 영수증 PDF 다운로드
        function downloadReceiptPDF() {
            showStatus('영수증 PDF 다운로드를 준비하는 중...', 'processing');
            setTimeout(function() {
                showStatus('인쇄 대화상자에서 "PDF로 저장"을 선택하세요.', 'success');
                window.print();
            }, 500);
        }

        // 전송용 파일 생성
        function generateExportFile() {
            if (!currentSignatureA) {
                showStatus('먼저 갑의 서명을 업로드하고 배치해주세요.', 'processing');
                return;
            }

            showStatus('전송용 HTML 파일을 생성하는 중...', 'processing');

            try {
                const docClone = document.documentElement.cloneNode(true);

                const sigA_data = signatureDataA;
                const sigA_style = {
                    left: currentSignatureA.style.left,
                    top: currentSignatureA.style.top,
                    width: currentSignatureA.style.width,
                    height: currentSignatureA.style.height,
                    opacity: currentSignatureA.style.opacity || 1
                };

                docClone.querySelector('#partyA').readOnly = true;
                docClone.querySelector('#representativeA').readOnly = true;
                docClone.querySelector('#businessNumber').readOnly = true;
                docClone.querySelector('#contactA').readOnly = true;
                docClone.querySelector('#addressA').readOnly = true;

                const sigUploadA = docClone.querySelector('#signatureUploadA');
                if (sigUploadA) sigUploadA.style.display = 'none';
                
                const exportTabButton = docClone.querySelector('button[data-tab="export"]');
                if(exportTabButton) exportTabButton.style.display = 'none';

                const injectionScript = docClone.ownerDocument.createElement('script');
                injectionScript.textContent = `
                    window.addEventListener('DOMContentLoaded', () => {
                        const preloadedSignatureDataA = "${sigA_data}";
                        const preloadedSignatureStyleA = ${JSON.stringify(sigA_style)};

                        if (preloadedSignatureDataA) {
                            signatureDataA = preloadedSignatureDataA;
                            
                            const sigOverlay = document.createElement('div');
                            sigOverlay.className = 'signature-overlay';
                            sigOverlay.style.position = 'absolute';
                            sigOverlay.style.left = preloadedSignatureStyleA.left;
                            sigOverlay.style.top = preloadedSignatureStyleA.top;
                            sigOverlay.style.width = preloadedSignatureStyleA.width;
                            sigOverlay.style.height = preloadedSignatureStyleA.height;
                            sigOverlay.style.opacity = preloadedSignatureStyleA.opacity;

                            const sigImg = document.createElement('img');
                            sigImg.src = preloadedSignatureDataA;
                            sigImg.className = 'signature-image';
                            sigOverlay.appendChild(sigImg);
                            
                            document.getElementById('documentCanvas').appendChild(sigOverlay);
                            currentSignatureA = sigOverlay;
                            makeDraggable(sigOverlay);
                            
                            const placeholderA = document.getElementById('signaturePlaceA');
                            if(placeholderA) {
                                placeholderA.innerHTML = '갑 서명 완료 ✓';
                                placeholderA.style.background = '#d4edda';
                                placeholderA.style.color = '#155724';
                            }
                        }
                        
                            // 을에게 보내는 파일에서 갑 서명 업로드 박스 숨기기
                            const sigUploadBoxA = document.getElementById('signatureUploadA');
                            if (sigUploadBoxA) {
                                sigUploadBoxA.style.display = 'none';
                            }
                            
                            // 을에게 보내는 파일에서 서명 탭 버튼 텍스트 변경
                            const downloadPdfBtn = document.getElementById('downloadPdfBtn');
                            if (downloadPdfBtn) {
                                downloadPdfBtn.textContent = '📄 완성된 계약서 보기';
                                downloadPdfBtn.onclick = function() {
                                    if (!currentSignatureB) {
                                        showStatus('을의 서명을 배치해주세요.', 'processing');
                                        return;
                                    }
                                    showTab('preview');
                                };
                            }
                        
                        showStatus("계약서 내용을 확인하고 '을' 정보를 입력한 뒤 서명을 진행해주세요.", 'success');
                        showTab('info');
                    });
                `;
                docClone.querySelector('body').appendChild(injectionScript);

                const exportHtml = '<!DOCTYPE html>\n' + docClone.outerHTML;
                
                const eventName = document.getElementById('eventName').value || '계약서';
                const blob = new Blob([exportHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = eventName + '_서명요청.html';
                a.style.display = 'none';
                
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 1000);
                
                showStatus('전송용 HTML 파일이 성공적으로 생성되었습니다!', 'success');
                
            } catch (error) {
                console.error('파일 생성 중 오류:', error);
                showStatus('파일 생성 중 오류 발생: ' + error.message, 'processing');
            }
        }

        // 체크리스트 업데이트
        function updateChecklist() {
            const eventName = document.getElementById('eventName').value;
            const partyA = document.getElementById('partyA').value;
            
            if (eventName && partyA) {
                document.getElementById('checkContract').innerHTML = '📋 계약 정보 입력: <span class="status-complete">완료</span>';
            } else {
                document.getElementById('checkContract').innerHTML = '📋 계약 정보 입력: <span class="status-pending">대기중</span>';
            }
            
            if (currentSignatureA) {
                document.getElementById('checkSignatureA').innerHTML = '✍️ 갑(본인) 서명: <span class="status-complete">완료</span>';
            } else {
                document.getElementById('checkSignatureA').innerHTML = '✍️ 갑(본인) 서명: <span class="status-pending">대기중</span>';
            }
            
            const canExport = eventName && partyA && currentSignatureA;
            document.getElementById('generateExportFile').disabled = !canExport;
        }

        // 상태 메시지 표시
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
            statusEl.classList.remove('hidden');
            
            if (type === 'success') {
                setTimeout(function() {
                    statusEl.classList.add('hidden');
                }, 3000);
            }
        }

        // PDF 다운로드 개선 (수정된 부분)
        function downloadPDF() {
            if (!currentSignatureA || !currentSignatureB) {
                showStatus('갑과 을의 서명을 모두 배치해주세요.', 'processing');
                return;
            }
            
            showStatus('PDF로 저장하시려면 인쇄 대화상자에서 "PDF로 저장"을 선택하세요.', 'success');
            
            // 인쇄 모드로 전환
            const originalDisplay = document.querySelector('.tabs').style.display;
            const originalControlsDisplay = document.querySelector('.controls').style.display;
            const originalSignatureSectionDisplay = document.querySelector('.signature-section').style.display;
            
            // 불필요한 요소들 숨기기
            document.querySelector('.tabs').style.display = 'none';
            document.querySelector('.controls').style.display = 'none';
            document.querySelector('.signature-section').style.display = 'none';
            
            // 잠시 후 인쇄 대화상자 열기
            setTimeout(() => {
                window.print();
                
                // 인쇄 후 원래 상태로 복원
                setTimeout(() => {
                    document.querySelector('.tabs').style.display = originalDisplay;
                    document.querySelector('.controls').style.display = originalControlsDisplay;
                    document.querySelector('.signature-section').style.display = originalSignatureSectionDisplay;
                }, 1000);
            }, 100);
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // 기본 템플릿 설정
            document.getElementById('contractTemplate').value = defaultTemplate;
            
            // 탭 클릭 이벤트
            document.querySelectorAll('.tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    showTab(tabName);
                });
            });
            
            // 파일 업로드 설정
            setupFileUpload(
                document.getElementById('signatureUploadA'),
                document.getElementById('signatureFileA'),
                handleSignatureUploadA
            );
            
            setupFileUpload(
                document.getElementById('signatureUploadB'),
                document.getElementById('signatureFileB'),
                handleSignatureUploadB
            );
            
            // 이벤트 리스너
            document.getElementById('taxRate').addEventListener('input', calculateAmounts);
            
            document.getElementById('sizeSlider').addEventListener('input', function(e) {
                const size = e.target.value;
                document.getElementById('sizeValue').textContent = size + 'px';
                
                if (selectedSignature) {
                    selectedSignature.style.width = size + 'px';
                    selectedSignature.style.height = (size * 0.5) + 'px';
                }
            });
            
            document.getElementById('opacitySlider').addEventListener('input', function(e) {
                const opacity = e.target.value;
                document.getElementById('opacityValue').textContent = opacity + '%';
                
                if (selectedSignature) {
                    selectedSignature.style.opacity = opacity / 100;
                }
            });
            
            document.getElementById('removeBackground').addEventListener('click', function() {
                showStatus('배경 제거 기능은 개발 중입니다.', 'processing');
            });
            
            // PDF 다운로드 버튼에 수정된 함수 연결
            document.getElementById('downloadPdfBtn').addEventListener('click', function() {
                if (!currentSignatureA || !currentSignatureB) {
                    showStatus('갑과 을의 서명을 모두 배치해주세요.', 'processing');
                    return;
                }
                
                // 완성된 계약서 탭으로 이동
                showTab('preview');
            });
            
            // 초기 계산
            calculateAmounts();
        });
    </script>
</body>
</html>